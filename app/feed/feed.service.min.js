"use strict";function FeedUtil(t){var e=function(t){t.formResult.compData.push({_id:null,name:null,value:0,cost:0}),t.calculate()},a=function(e,a,n){e.formResult.compData[a]._id=n;var o=t.find(e.compData,{_id:n});o&&(e.formResult.compData[a].name=o.name,e.calculate())},n=function(t,e){t.formResult.compData[e]._id=null,t.formResult.compData[e].name=null,t.calculate()},o=function(t,e){t.formResult.compData.splice(e,1),t.calculate()},i=function(e){t.map(e.formResult.compData,function(t){t.value=0}),e.formResult.compData[0].value=100,e.formResult.nutritionData=null,e.calculate()},u=function(e){var a=0;e.formResult.compData.length>2?a=t.rest(e.formResult.compData).reduce(function(t,e){return t+e.value},0):2===e.formResult.compData.length&&(a=e.formResult.compData[1].value);var n=100-a;n>=0?e.formResult.compData[0].value=n:Messenger().post("Warning: Sum of component quantities exceeds 100%. Please delete a component or change its quantity."),e.formResult.weight&&(e.feedCost=e.formResult.compData.reduce(function(t,a){return t+.01*a.value*e.formResult.weight*a.cost},0)),1===e.formResult.compData.length&&null===e.formResult.compData[0]._id?e.formResult.nutritionData=null:(e.compNutrients=t.compact(e.formResult.compData.map(function(a){return a._id?t.find(e.compData,{_id:a._id}).nutrients:void 0})),e.nutrientList=t.compact(e.compNutrients.map(function(a,n){return t.mapValues(a,function(t){return{name:t.name,value:t.value*e.formResult.compData[n].value*.01,unit:t.unit}})})),e.formResult.nutritionData=t.reduce(e.nutrientList,function(e,a){var n=t.keys(e),o=t.keys(a),i=t.difference(n,o),u=t.difference(o,n);return t.map(i,function(t){a[t]={name:e[t].name,value:0,unit:e[t].unit}}),t.map(u,function(t){e[t]={name:a[t].name,value:0,unit:a[t].unit}}),t.merge(t.clone(e),a,function(t,e){var a=t.value+e.value;return{name:t.name,value:+a.toPrecision(3),unit:t.unit}})}),e.formResult.nutritionData&&(e.maxAchievableNutrients={},Object.keys(e.formResult.nutritionData).forEach(function(a){var n=t.max(e.compNutrients,function(t){return a in t?t[a].value:0});e.maxAchievableNutrients[a]=n[a].value}),Object.keys(e.formResult.nutritionData).forEach(function(t){e.formResult.nutritionData[t].maxAchievable=e.maxAchievableNutrients[t]})))},l=function(e){var a=new Solver;e.model={optimize:"cost",opType:"min",constraints:{totalWeight:{min:100,max:100}},variables:{}},e.formResult.compData.forEach(function(t){e.model.variables[t._id]={cost:t.cost,totalWeight:1},(t.min||t.max)&&(e.model.variables[t._id][t._id+"_weight"]=1,e.model.constraints[t._id+"_weight"]={},t.min&&(e.model.constraints[t._id+"_weight"].min=t.min),t.max&&(e.model.constraints[t._id+"_weight"].max=t.max))});for(var n in e.formResult.optData){var o=e.formResult.optData[n].min,i=e.formResult.optData[n].max;if(o||i){for(var u in e.model.variables){var l=t.find(e.compData,{_id:u}).nutrients[n];l&&(e.model.variables[u][n]=.01*l.value)}e.model.constraints[n]={},o&&(e.model.constraints[n].min=o),i&&(e.model.constraints[n].max=i)}}e.results=1===Object.keys(e.model.constraints).length?{feasible:!1}:a.Solve(e.model),e.results.feasible&&(e.formResult.compData.map(function(t){t.value=t._id in e.results?+e.results[t._id].toFixed(2):0}),e.calculate()),$("#optResultModal").modal({backdrop:!0})};this.addNewComp=e,this.calculate=u,this.nullifyComp=n,this.optFeed=l,this.removeComp=o,this.resetComps=i,this.updateComp=a}angular.module("app.feed-service",["ngLodash"]).service("FeedUtil",FeedUtil),FeedUtil.$inject=["lodash"];